<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="statisticalTimeSeries">

    <select id="getGeoJson" parameterType="String" resultType="String">
        select row_to_json(fsts)
          from ( select 'Feature' as "type",
                          ml.monitoring_location_identifier as "id",
                          json_build_object(
                             'type', 'Point',
                             'coordinates', json_build_array(
                                 to_json(trunc(st_x(st_transform(geom, 4326))::numeric, 7)),
                                 to_json(trunc(st_y(st_transform(geom, 4326))::numeric, 7))
                             )
                          ) as "geometry",
                          json_build_object('samplingFeatureName', site_name) as "properties",
                          ( select array_to_json(array_agg(sts))
                              from ( select distinct 
                                            groundwater_daily_value_identifier as "id",
                                            observered_property_name||', '||statistic as "description",
                                            observered_property_id as "parameterCode",
                                            statistic_id as "statisticCode",
                                            #{serverBaseURL,jdbcType=VARCHAR} -- default https://labs-dev.wma.chs.usgs.gov
                                                ||'/api/observations/monitoring-location/'
                                                ||monitoring_location_identifier
                                                ||'/statistical-time-series/'
                                                ||time_series_unique_id
                                                   as "url"
                                       from nwis.groundwater_daily_value gw
                                      where gw.monitoring_location_id = ml.monitoring_location_id
                                   ) as sts -- sts is statistical time series
                          ) as "timeSeries" -- becomes the json key
                   from nwis.monitoring_location ml
                  where geom is not null
                    and ml.monitoring_location_identifier=#{featureId,jdbcType=VARCHAR}
               ) fsts -- fsts is feature statistical time series
    </select>

</mapper>

